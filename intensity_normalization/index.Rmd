---
title: "Intensity Normalization"
author: "Kristin Linn"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    widescreen: yes
  beamer_presentation: default    
bibliography: ../refs.bib      
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", fig.height = 5, fig.width = 5, cache = TRUE)
options(fsl.path = "/usr/local/fsl/")
options(fsl.outputtype = "NIFTI_GZ")
```

## Intensity normalization
- Conventional MRI intensites (T1-w, T2-w, PD, FLAIR) are acquired in arbitrary units, making the images not comparable across scanners and visits. 
- Intensity normalization brings the intensities to a common scale.


## Goals of this tutorial
- Visualize the intensities using boxplots and densities
- Apply the WhiteStripe intensity normalization [@shinohara2014statistical]


## Reading in the images
- For the moment, we will work with the T1-w images from the training data. 
- `vals` below is restricting to T1-w voxels that are within the brain mask.

```{r t1, warning=FALSE, message=FALSE}
library(ms.lesion)
library(neurobase)
library(WhiteStripe)
fnames = get_image_filenames_list_by_subject(group = "training", 
  type = "coregistered")
t1s = lapply(fnames, function(x) readnii(x["MPRAGE"]))
tissues = lapply(fnames, function(x) readnii(x["Tissue_Classes"]))
masks = lapply(fnames, function(x) readnii(x["Brain_Mask"]))

vals = mapply(function(t1, mask){
  mask_vals(t1, mask)
}, t1s, masks, SIMPLIFY = FALSE)

dens = lapply(vals, density)
```

## Code for plotting the data
```{r show_code}
plot_densities = function(dens, xlab = "Raw Intensities", 
                          main = "Whole Brain") {
  range_x = sapply(dens, function(d) range(d$x))
  range_x = range(range_x)
  range_y = sapply(dens, function(d) range(d$y))
  range_y = range(range_y)
  plot(dens[[1]], xlim = range_x, ylim = range_y, 
       xlab = xlab, main = main)
  for (idens in 2:length(dens)) {
    lines(dens[[idens]], col = idens)
  }
}
plot_boxplots = function(vals, 
                          main = "Whole Brain") {
  boxplots <- lapply(vals, boxplot, outline = FALSE, plot = FALSE)
  boxplots = lapply(boxplots, function(x) x$stats)
  boxplots <- do.call(cbind, boxplots)
  boxplot(boxplots, main = main)
}
```

## Visualizing the intensities 

- Full brain densities are mixtures of the tissue class distributions.

<div class="columns-2">
```{r t1viz, warning=FALSE, message=FALSE}
plot_densities(dens)
```

```{r t1box, echo = FALSE}
plot_boxplots(vals)
```
</div>

## Visualizing the intensities by tissue class

<div class="columns-2">
```{r t1viz2, warning=FALSE, message=FALSE, echo = FALSE}
gm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 2)
}, t1s, tissues, SIMPLIFY = FALSE)
gm_dens = lapply(gm_vals, density)
plot_densities(gm_dens, main = "Gray Matter")
```

```{r gm_raw_box, echo = FALSE}
plot_boxplots(gm_vals, main = "Gray Matter")
```
</div>

## Visualizing the intensities by tissue class
- Notice the complete non-overlap between some subjects' white matter distributions.

<div class="columns-2">

```{r t1viz3, warning=FALSE, message=FALSE, echo = FALSE}
wm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 3)
}, t1s, tissues, SIMPLIFY = FALSE)
wm_dens = lapply(wm_vals, density)
plot_densities(wm_dens, main = "White Matter")
```

```{r wm_raw_box, echo = FALSE}
plot_boxplots(wm_vals, main = "White Matter")
```
</div>

## Visualizing the intensities by tissue class
<div class="columns-2">

```{r t1viz1, warning=FALSE, message=FALSE, echo = FALSE}
csf_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 1)
}, t1s, tissues, SIMPLIFY = FALSE)
csf_dens = lapply(csf_vals, density)
plot_densities(csf_dens, main = "CSF")
```

```{r csf_raw_box, echo = FALSE}
plot_boxplots(csf_vals, main = "CSF")
```
</div>

## Whole-brain normalization
- Let's Z-score each voxel using mean and standard deviation computed from all voxels in the brain mask.
- `zscore_img` is a function in `fslr` that does this.

```{r wbViz, warning=FALSE, message=FALSE}
t1_norm = mapply(function(img, mask){
  zscore_img(img = img, mask = mask, margin = NULL)
}, t1s, masks, SIMPLIFY = FALSE)
```

## Whole-brain normalized intensities
- Gray matter distributions are more comparable.
<div class="columns-2">
```{r wbViz2, warning=FALSE, message=FALSE, echo = FALSE}
gm_norm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 2)
}, t1_norm, tissues, SIMPLIFY = FALSE)
gm_norm_dens = lapply(gm_norm_vals, density)
plot_densities(gm_norm_dens, 
               xlab = "Whole-brain Normalized Intensities", 
               main = "Gray Matter")
```

```{r gm_box, echo = FALSE}
plot_boxplots(gm_norm_vals, main = "Gray Matter")
```
</div>


## Whole-brain normalized intensities
- White matter distributions are more comparable.

<div class="columns-2">
```{r wbViz3, warning=FALSE, message=FALSE, echo = FALSE}
wm_norm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 3)
}, t1_norm, tissues, SIMPLIFY = FALSE)
wm_norm_dens = lapply(wm_norm_vals, density)
plot_densities(wm_norm_dens, 
               xlab = "Whole-brain Normalized Intensities", 
               main = "White Matter")
```


```{r wm_box, echo = FALSE}
plot_boxplots(wm_norm_vals, main = "White Matter")
```
</div>

## Whole-brain normalized intensities

<div class="columns-2">
```{r wbViz1, warning=FALSE, message=FALSE, echo = FALSE}
csf_norm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 1)
}, t1_norm, tissues, SIMPLIFY = FALSE)
csf_norm_dens = lapply(csf_norm_vals, density)
plot_densities(csf_norm_dens, 
               xlab = "Whole-brain Normalized Intensities", 
               main = "CSF")
```

```{r csf_box, echo = FALSE}
plot_boxplots(csf_norm_vals, main = "CSF")
```
</div>

## Why White Stripe?
- Whole-brain normalization may reduce signal in the higher intensities, i.e., less contrast between lesion intensities and normal appearing white matter.
- White Stripe normalization is based on parameters obtained from a sample of normal appearing white matter. 
- The idea is to make normal appearing white matter comparable across subjects while preserving high lesion intensity contrast to aid automatic segmentation algorithms.

## White Stripe normalization
- We normalize each voxel using the mean and standard deviation computed from normal appearing white matter voxels.
- Thus, normal appearing white matter will have a standard normal distribution.
- Units will correspond to variability (standard deviation) of normal appearing white matter.
- Gray matter and CSF distributions, however, may not be comparable across subjects.

```{r ws, warning = FALSE, message = FALSE, results='hide'}
ws_norm = function(t1) {
  ind = whitestripe(img = t1,
                    type = "T1", 
                    stripped = TRUE)$whitestripe.ind
  whitestripe_norm(t1, indices = ind)
}
t1_ws_norm = lapply(t1s, ws_norm)
```

## WhiteStripe normalized intensities

<div class="columns-2">
```{r ws_viz_gm, warning=FALSE, message=FALSE, echo = FALSE}
gm_norm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 2)
}, t1_ws_norm, tissues, SIMPLIFY = FALSE)
gm_norm_dens = lapply(gm_norm_vals, density)
plot_densities(gm_norm_dens, 
               xlab = "WhiteStripe Normalized Intensities", 
               main = "Gray Matter")
```

```{r d2, echo = FALSE}
plot_boxplots(gm_norm_vals, main = "Gray Matter")
```
</div>

## WhiteStripe normalized intensities

<div class="columns-2">

```{r ws_viz_wm, warning=FALSE, message=FALSE, echo = FALSE}
wm_norm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 3)
}, t1_ws_norm, tissues, SIMPLIFY = FALSE)
wm_norm_dens = lapply(wm_norm_vals, density)
plot_densities(wm_norm_dens, 
               xlab = "WhiteStripe Normalized Intensities", 
               main = "White Matter")
```

```{r ws_viz_wm_box, echo = FALSE}
plot_boxplots(wm_norm_vals, main = "White Matter")
```
</div>


## WhiteStripe normalized intensities

<div class="columns-2">
```{r ws_viz_csf, warning=FALSE, message=FALSE, echo = FALSE}
csf_norm_vals = mapply(function(t1, mask){
  mask_vals(t1, mask == 1)
}, t1_ws_norm, tissues, SIMPLIFY = FALSE)
csf_norm_dens = lapply(csf_norm_vals, density)
plot_densities(csf_norm_dens, 
               xlab = "WhiteStripe Normalized Intensities", 
               main = "CSF")
```

```{r csf_viz_wm_box, echo = FALSE}
plot_boxplots(csf_norm_vals, main = "CSF")
```
</div>

## Conclusions
- Intensity normalization is an important step in any image analysis with more than one subject or time point to ensure comparability across images.
- White Stripe normalization may work better for subsequent lesion segmentation algorithms or analysis.
- Newer methods exist, such as RAVEL, which extends WhiteStripe to make intensites comparable across subjects for all tissues [@fortin2016removing].

## References {.smaller}


<!-- ## Intensity normalization with RAVEL -->

<!-- - WhiteStripe is great, it normalized the WM intensities across samples -->
<!-- - Grey matter (GM) and cerebrospinal fluid (CSF) intensites are still not comparable -->
<!-- - RAVEL extends WhiteStripe to make intensites comparable across subjects for all tissues -->









