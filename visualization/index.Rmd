---
title: "Visualization of NIfTI Images"
output:
  ioslides_presentation:
    widescreen: yes
    css: ../styles.css
  beamer_presentation: default
bibliography: ../refs.bib
---

```{r setup, include=FALSE, message = FALSE}
library(methods)
knitr::opts_chunk$set(echo = TRUE, comment = "")
library(ggplot2)
library(ms.lesion)
library(neurobase)
library(extrantsr)
library(scales)
```

## Formats of Images

There are multiple imaging formats.  We will use NIfTI:

* NIfTI - Neuroimaging Informatics Technology Initiative (https://nifti.nimh.nih.gov/nifti-1)
    - essentially a header and data (binary format)
    - will have extension .nii (uncompressed) or .nii.gz (compressed)
    - we will primarily use compressed NIfTI images
    - we will use 3-D images (4-D and 5-D are possible)
* ANALYZE 7.5 was a precursor to NIfTI 
    - had a `hdr` file (header) and `img` file (data)


# Imaging Packages in R

## What is a package?

A package is collection of functions, documentation, data, and tutorials (called vignettes).

- You install a package using the `install.packages` command/function:

```r
install.packages("oro.nifti")
```

`install.packages` is a function, `"oro.nifti"` is a character string.


## Loading Packages

When you install a package, that means it's downloaded on your computer.  That **doesn't** mean that you can use the functions from that package just yet.

- You "load"/import a package into memory using the `library` command

For example, to load the `oro.nifti` package:

```r
library(oro.nifti)
```

Now, functions from the `oro.nifti` package can be used.

## Some packages we will use

All packages we will discuss are loaded on the RStudio Server:

* `oro.nifti` - reading/writing NIfTI images
* `neurobase` - extends `oro.nifti` and provides helpful imaging functions

Let's load them:

```{r, message=FALSE}
library(oro.nifti)
library(neurobase)
```


## Multiple Sclerosis Data

- Multiple sclerosis is a chronic disease of the central nervous system (brain, spinal chord, optic nerves)
- Multiple sclerosis lesions in the brain are areas of active inflammation, demylenation, or permanent tissue damage. 
    - lesions are primarily in the white matter
- MRI is well-suited for assessing lesion burden (volume and patterns) because lesions appear as hyperintensities on FLAIR, T2-w, and PD images and as hypointensities on T1-w images.
- Using 5 training and 3 test subjects data from the MS lesion challenge 2016 (http://iacl.ece.jhu.edu/index.php/MSChallenge)

- The full data is available at https://smart-stats-tools.org. 


## Reading in NIfTI images: assignment

We will use the `readnii` function (from `neurobase`) to read in a `nifti` object (this is an `R` object).

Here we read in the `training01_01_mprage.nii.gz` file, and assign it to an object called `t1`
```{r}
t1 = readnii("training01_01_mprage.nii.gz")
```

Now, an object `t1` is in memory/the workspace.

## Reading in NIfTI images: assignment

In `R`, you can assign using the equals `=` or arrow `<-` (aka assigment operator).

The above command is equivalent to:

```{r, eval = FALSE}
t1 <- readnii("training01_01_mprage.nii.gz")
```

There are no differences in these 2 commands, but just personal preference.


## `nifti` images

By default, if you simply pass the object, it is printed, we can also do `print(t1)`:
```{r}
class(t1)
t1
```

## Help

- To see the documentation for a function, use the `?` symbol before the name of the function.  This is a shortcut for the `help` command:
- For example, to see documentation for `readnii`:

```{r help, eval = FALSE}
?readnii
help(topic = "readnii")
```
- To search for help files, use a double `??` or `help.search`:

```{r help2, eval = FALSE}
??readnii
help.search(pattern = "readnii")
```

## Some Details

- R is case sensitive (e.g. `y` and `Y` are different)
- Commands separated by new line or by a colon (;)
- Use `#` to comment

You can also be explicit about which package you are using with the `::` operator, where the syntax is `package::function`:

```{r colon_twice, eval=FALSE}
t1 = neurobase::readnii("training01_01_mprage.nii.gz")
```


## Orthographic view with additions

The `neurobase::ortho2` function displays nifti objects in 3 different planes.

```{r ortho2}
neurobase::ortho2(t1)
```

## Why is it so dark - high intensities

```{r histog, echo = FALSE}
hist(c(t1))
```

## Brightening up the image

We see a faint outline of the image, but this single large value affects how we view the image.  The function `robust_window` calculates quantiles of an image, by default the 0 (min) and 99.9th quantile, and sets values outside of this range to that quantile.  

```{r ortho2_rob}
ortho2(robust_window(t1))
```

## Orthographic view with additions

`ortho2` annotates the orientation of the image.  These many not be correct.  You can turn these off with the `add.orient` argument:

```{r ortho2_noorient}
neurobase::ortho2(robust_window(t1), add.orient = FALSE)
```


## Overlaying images in `ortho2`

Here we plot the T1 and a binary image of values over $100$:

```{r ortho_nona}
orthographic(robust_window(t1), y = t1 > 100)
```


## Double orthographic view

Sometimes you would like to represent 2 images side by side, of the same dimensions and orientation of course.  The `double_ortho` function allows you to do this.

## Double viewing images

We can view the original T1 alongside the high values (useful for checking registration):

```{r double_ortho}
double_ortho(robust_window(t1), y = t1 > 100)
```

## Lightbox slice view

We may want to view a single slice of an image.  The `oro.nifti::image` function shows a lightbox view:

```{r all_slices}
image(t1) # look at average brightness over each slice
```

## Multiple Slices but not All 

The `slice` function can plot individual slices:

```{r two_slicewslice}
oro.nifti::slice(t1, z = c(60, 80))
```

### Different Planes

We can specify `z` the same way but change the `plane` to be different to get a different slice of the brain:

```{r one_slice_sag}
oro.nifti::slice(t1, z = 125, plane = "sagittal")
```
We can similarly do the same for "coronal" slices.

## Overlaying slices

We can also overlay one slice of an image upon another using the `oro.nifti::slice_overlay` function.  
```{r one_slice_overlay}
slice_overlay(t1, y = t1 > 100, z = 80)
```


## Conclusions

- `ortho2` - show orthographic images (and with overlays)
- `image` - shows multiple slices of an image (by default)
- `slice` - shows only specified slices
- `overlay` - similar to `image` but with an overlay
- `double_ortho` - similar to `ortho2` but side-by-side
- `robust_window` - good for setting high values to not so high
- the `*EmptyImageDimensions` functions are good for removes "extraneous" slices for zooming in





<!-- ## `ms.lesion` Package -->

<!-- The `ms.lesion` package was made for this course.  It has all the data we will work with and the outputs from the analyses.   -->

<!-- The main function we will use is `get_image_filenames_list_by_subject`.  It returns a `list` of filenames of the images for the 5 training and 3 test subjects from the MS lesion challenge 2016 (http://iacl.ece.jhu.edu/index.php/MSChallenge) -->

<!-- - The full data is available at https://smart-stats-tools.org.  -->


<!-- ## `ms.lesion` Package -->

<!-- ```{r} -->
<!-- library(ms.lesion) -->
<!-- files = get_image_filenames_list_by_subject() -->
<!-- length(files); names(files);  -->
<!-- ``` -->
<!-- ```{r, eval = FALSE} -->
<!-- head(files$training01) -->
<!-- ``` -->
<!-- ```{r, echo = FALSE} -->
<!-- f = files$training01 -->
<!-- f = strsplit(f, "/") -->
<!-- f = sapply(f, function(x){ -->
<!--   ind = which(x == "library") -->
<!--   x = x[ind:length(x)] -->
<!--   x = paste(x, collapse = "/") -->
<!-- }) -->
<!-- head(f) -->
<!-- rm(list = "f") -->
<!-- ``` -->


<!-- ## Reading in a T1 image -->

<!-- Let's read in the T1 image from a MS lesion data set to visualize: -->

<!-- ```{r} -->
<!-- files = files$training01 -->
<!-- t1_fname = files["MPRAGE"] -->
<!-- t1 = readnii(t1_fname) -->
<!-- t1 -->
<!-- ``` -->


<!-- ## Changing the Windowing -->

<!-- The `zlim` option can also map intensities that can be plotted: -->

<!-- ```{r ortho2_zlim} -->
<!-- ortho2(t1, zlim = quantile(t1, probs = c(0, 0.999))) -->
<!-- ``` -->




<!-- ## Dropping empty dimensions -->

<!-- In some instances, there are extraneous slices to an image.  For example, in the Eve template image we read in, it is just the brain.  Areas of the skull and extracranial tissue are removed, but the slices remain so that the brain image and the original image are in the same space with the same dimensions.  For plotting or further analyses, we can drop these empty dimensions using the `neurobase::dropEmptyImageDimensions` function.  -->


<!-- By default, if one `nifti` is passed to the function and `keep_ind = FALSE`, then the return is a `nifti` object.  -->

<!-- ```{r dd, cache=FALSE} -->
<!-- reduced_mask = dropEmptyImageDimensions(qmask) -->
<!-- dim(qmask) -->
<!-- dim(reduced_mask) -->
<!-- ``` -->

<!-- ## Plotting the Reduced Image -->

<!-- ```{r plot_red_mask} -->
<!-- ortho2(reduced_mask) -->
<!-- ``` -->

<!-- ## Dropping empty dimensions -->

<!-- Many times, you want to get empty dimensions from some sort of mask/region of interest, then apply that dropping procedure to an image you want to visualize -->

<!-- ```{r dd_get, cache=FALSE} -->
<!-- keep_inds = getEmptyImageDimensions(qmask) -->
<!-- reduced_img = applyEmptyImageDimensions(t1, inds = keep_inds) -->
<!-- ortho2(reduced_mask) -->
<!-- ``` -->
